# 🗄️ Render.com Database & Secrets Yönetimi

## 📊 Database Yönetimi

### 1. PostgreSQL Database Oluşturma

#### Render Dashboard'dan:
1. **New +** → **PostgreSQL**
2. **Database Ayarları:**
   ```
   Name: aslaw-db
   Database Name: aslaw
   User: aslaw_user
   Region: Frankfurt (aynı region'da olmalı)
   Plan: Free (512MB RAM, 1GB Storage)
   ```

#### Otomatik Oluşturulan Bilgiler:
```bash
# Render otomatik oluşturur
Database URL: postgresql://aslaw_user:password@hostname:5432/aslaw
Internal Database URL: postgresql://aslaw_user:password@internal-hostname:5432/aslaw
External Database URL: postgresql://aslaw_user:password@external-hostname:5432/aslaw
```

### 2. Database Connection Strings

#### Production Properties Güncellemesi:
```yaml
# application-prod.yml
spring:
  datasource:
    # Render otomatik inject eder
    url: ${DATABASE_URL}
    username: ${DATABASE_USER}
    password: ${DATABASE_PASSWORD}
    driver-class-name: org.postgresql.Driver
    
  jpa:
    hibernate:
      ddl-auto: validate # Production'da validate kullan
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    enabled: true
```

### 3. Database Erişimi

#### A) Render Dashboard'dan:
1. **Database Service** → **Connect**
2. **Query Editor** ile direkt SQL çalıştırabilirsiniz
3. **Metrics** sekmesinden performans izleme

#### B) External Tool'lar:
```bash
# pgAdmin, DBeaver, DataGrip için
Host: dpg-xxxxxxxxx-a.frankfurt-postgres.render.com
Port: 5432
Database: aslaw
Username: aslaw_user
Password: <render-generated-password>
SSL Mode: Require
```

#### C) psql CLI:
```bash
# Render'dan connection string kopyalayın
psql postgresql://aslaw_user:password@hostname:5432/aslaw

# Veya environment variable kullanın
psql $DATABASE_URL
```

### 4. Database Backup & Restore

#### Otomatik Backup:
- **Free Plan:** 7 gün backup retention
- **Paid Plan:** 30 gün backup retention
- Render otomatik daily backup alır

#### Manuel Backup:
```bash
# pg_dump kullanarak
pg_dump $DATABASE_URL > backup.sql

# Restore
psql $DATABASE_URL < backup.sql
```

#### Render Dashboard'dan:
1. **Database Service** → **Backups**
2. **Create Backup** → Manuel backup
3. **Restore from Backup** → Geri yükleme

## 🔐 Secrets & Environment Variables

### 1. Environment Variables Türleri

#### A) Service Environment Variables:
```bash
# Web Service → Environment sekmesi
SPRING_PROFILES_ACTIVE=prod
JWT_SECRET=<auto-generated-secret>
UPLOAD_PROVIDER=local
UPLOAD_DIR=/app/uploads
```

#### B) Database Connection (Otomatik):
```bash
# Render otomatik inject eder
DATABASE_URL=postgresql://...
DATABASE_USER=aslaw_user  
DATABASE_PASSWORD=<auto-generated>
```

#### C) Build-time Secrets:
```bash
# Docker build için
GITHUB_USERNAME=fthgcr
GITHUB_TOKEN=ghp_xxxxxxxxxxxx
```

### 2. Secrets Ekleme Yöntemleri

#### A) Render Dashboard'dan:
1. **Web Service** → **Environment**
2. **Add Environment Variable**
3. **Key/Value** girin
4. **Save Changes**

#### B) render.yaml ile:
```yaml
envVars:
  # Statik değerler
  - key: SPRING_PROFILES_ACTIVE
    value: prod
    
  # Auto-generated secrets
  - key: JWT_SECRET
    generateValue: true
    
  # Database'den otomatik
  - key: DATABASE_URL
    fromDatabase:
      name: aslaw-db
      property: connectionString
      
  # Manuel girmeniz gereken
  - key: GITHUB_TOKEN
    sync: false # Dashboard'dan manuel girin
```

### 3. Güvenli Secret Yönetimi

#### GitHub Token (Kritik):
```bash
# 1. GitHub'da token oluştur
GitHub → Settings → Developer settings → Personal access tokens

# 2. Scope'lar
✅ read:packages
✅ repo (private repo için)

# 3. Render'a ekle
GITHUB_TOKEN=ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

#### JWT Secret:
```bash
# Render otomatik oluşturur (önerilen)
JWT_SECRET=<auto-generated-256-bit-secret>

# Veya kendi secret'ınızı kullanın
JWT_SECRET=myVerySecureJWTSecretKey123456789
```

#### Database Secrets:
```bash
# Render otomatik yönetir
DATABASE_URL=postgresql://user:pass@host:5432/db
DATABASE_USER=aslaw_user
DATABASE_PASSWORD=<auto-generated>
```

### 4. Production Properties Güncellemesi

#### Güncellenmiş application-prod.yml:
```yaml
spring:
  application:
    name: aslaw-backend
  
  datasource:
    # Render environment variables
    url: ${DATABASE_URL}
    driver-class-name: org.postgresql.Driver
    hikari:
      maximum-pool-size: 5 # Free plan için optimize
      connection-timeout: 20000
      
  jpa:
    hibernate:
      ddl-auto: validate
    show-sql: false
    properties:
      hibernate:
        dialect: org.hibernate.dialect.PostgreSQLDialect
        jdbc:
          time_zone: UTC
          
  liquibase:
    change-log: classpath:db/changelog/db.changelog-master.xml
    enabled: true
    
server:
  port: ${PORT:8080} # Render PORT variable
  
management:
  endpoints:
    web:
      exposure:
        include: health,info
  endpoint:
    health:
      show-details: when-authorized
      
# JWT Configuration
jwt:
  secret: ${JWT_SECRET}
  expiration: 86400000 # 24 hours
  
# File Upload
upload:
  provider: ${UPLOAD_PROVIDER:local}
  local:
    directory: ${UPLOAD_DIR:/app/uploads}
  max-file-size: 10MB
  
# Logging
logging:
  level:
    com.aslaw: INFO
    org.springframework.security: WARN
    org.hibernate: WARN
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n"
```

## 🔧 Render.yaml Güncellemesi

```yaml
services:
  - type: web
    name: aslaw-backend
    env: docker
    dockerfilePath: ./Dockerfile
    plan: free
    region: frankfurt
    branch: main
    healthCheckPath: /actuator/health
    
    # Docker build arguments
    dockerBuildArgs:
      - key: GITHUB_USERNAME
        value: fthgcr
      - key: GITHUB_TOKEN
        fromEnvVar: GITHUB_TOKEN
    
    # Runtime environment variables
    envVars:
      - key: SPRING_PROFILES_ACTIVE
        value: prod
        
      # Database connection (otomatik)
      - key: DATABASE_URL
        fromDatabase:
          name: aslaw-db
          property: connectionString
          
      # Auto-generated secrets
      - key: JWT_SECRET
        generateValue: true
        
      # Static configuration
      - key: UPLOAD_PROVIDER
        value: local
      - key: UPLOAD_DIR
        value: /app/uploads
        
      # Manuel secrets (Dashboard'dan ekleyin)
      - key: GITHUB_TOKEN
        sync: false

databases:
  - name: aslaw-db
    databaseName: aslaw
    user: aslaw_user
    plan: free
    region: frankfurt
```

## 📋 Deployment Checklist

### 1. Database Setup:
- [ ] PostgreSQL database oluşturuldu
- [ ] Connection string'ler otomatik inject edildi
- [ ] Database migrations çalışıyor

### 2. Secrets Configuration:
- [ ] GitHub token eklendi
- [ ] JWT secret auto-generated
- [ ] Database credentials otomatik

### 3. Environment Variables:
- [ ] SPRING_PROFILES_ACTIVE=prod
- [ ] DATABASE_URL set edildi
- [ ] Tüm required variables mevcut

### 4. Security:
- [ ] Secrets dashboard'da gizli
- [ ] Database external access kısıtlı
- [ ] SSL/TLS aktif

## 🚨 Güvenlik Best Practices

### 1. Secret Rotation:
```bash
# JWT Secret'ı periyodik olarak değiştirin
# GitHub Token'ı 90 günde bir yenileyin
# Database password'ü Render otomatik yönetir
```

### 2. Access Control:
```bash
# Database sadece internal network'den erişilebilir
# External access sadece gerektiğinde aktif edin
# Development/Production secrets'ı ayırın
```

### 3. Monitoring:
```bash
# Render Dashboard → Metrics
# Database connection pool monitoring
# Failed authentication attempts
```

## 🔍 Troubleshooting

### Database Connection Issues:
```bash
# 1. Connection string'i kontrol edin
echo $DATABASE_URL

# 2. Database service'in UP olduğunu kontrol edin
# 3. Region'ların aynı olduğunu doğrulayın
# 4. Firewall rules kontrol edin
```

### Secret Issues:
```bash
# 1. Environment variables'ları kontrol edin
# 2. Case-sensitive olduğunu unutmayın
# 3. Special characters'ları escape edin
# 4. Redeploy yapın (secrets değiştiğinde)
```

---

✅ **Bu rehberle:**
- Database'i güvenli şekilde yönetebilirsiniz
- Secrets'ları doğru konfigüre edebilirsiniz  
- Production'da sorunsuz çalışır
- Güvenlik best practices'larını uygularsınız 